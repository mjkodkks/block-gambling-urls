name: Update Blocklist

on:
  push:
    branches:
      - main
    paths:
      - 'block_url.txt'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-version:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Update version number
        run: |
          # Get current date in format DD.MM.YYYY.NN
          CURRENT_DATE=$(date +"%d.%m.%Y")

          # Extract current version from block_url.txt
          CURRENT_VERSION=$(grep "^! Version:" block_url.txt | sed 's/^! Version: //')

          # Check if version already has today's date
          if echo "$CURRENT_VERSION" | grep -q "^$CURRENT_DATE"; then
            # Extract increment number
            INCREMENT=$(echo "$CURRENT_VERSION" | sed "s/$CURRENT_DATE\.//")
            # Remove all leading zeros using arithmetic expansion
            INCREMENT=$((10#$INCREMENT))
            NEW_INCREMENT=$(printf "%02d" $((INCREMENT + 1)))
          else
            NEW_INCREMENT="01"
          fi

          NEW_VERSION="${CURRENT_DATE}.${NEW_INCREMENT}"

          echo "Current version: $CURRENT_VERSION"
          echo "New version: $NEW_VERSION"

          # Update version in block_url.txt
          sed -i "s/^! Version: .*/! Version: $NEW_VERSION/" block_url.txt

      - name: Validate Adblock Plus format
        run: bash .github/scripts/validate-blocklist.sh

      - name: Commit changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add block_url.txt

          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: auto-update blocklist version"
            git push
          fi
